name: Auto PR with Random File

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      # 1. 克隆你的 fork
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          repository: qinjunhaocn/apr
          ref: main
          fetch-depth: 0

      # 2. 配置 Git
      - name: Configure Git
        run: |
          git config --global user.name "qinjunhaocn"
          git config --global user.email "avf_j7b6@163.com"
      # 3. 创建并切换到新分支
      - name: Create branch
        run: |
          BRANCH_NAME="auto-pr-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      # 4. 写入随机文件
      - name: Create random file in prs/
        run: |
          FILENAME="prs/random_$(date +%s).txt"
          echo "Auto-generated at $(date)" > "$FILENAME"
          git add "$FILENAME"

      # 5. 提交并推送到你的 fork
      - name: Commit & push to fork
        run: |
          git commit -m "Add random file via GitHub Actions"
          git push origin "$BRANCH_NAME"

      # 6. 克隆上游仓库到临时目录
      - name: Clone upstream repo
        run: |
          git clone https://github.com/qinjunhaocn2/apr.git upstream-repo
          cd upstream-repo
          git remote add fork https://x-access-token:${{ secrets.MY_GITHUB_TOKEN }}@github.com/qinjunhaocn/apr.git
          git fetch fork "$BRANCH_NAME"

      # 7. 在上游目录里 cherry-pick、删 .github、推送
      - name: Push to upstream and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          cd upstream-repo
          git checkout -b "$BRANCH_NAME" origin/main
          git cherry-pick fork/"$BRANCH_NAME" --strategy=recursive -X theirs
          rm -rf .github
          git add -A
          git commit --amend --no-edit --allow-empty
          git remote set-url origin https://x-access-token:${{ secrets.MY_GITHUB_TOKEN }}@github.com/qinjunhaocn2/apr.git
          git push -u origin "$BRANCH_NAME"

          # 用 gh CLI 创建 PR
          gh pr create \
            --title  "Auto PR: Add random file" \
            --body   "This PR was automatically created by GitHub Actions. It adds a random file to the \`prs/\` directory." \
            --base   main \
            --head   "$BRANCH_NAME" \
            --repo   qinjunhaocn2/apr
