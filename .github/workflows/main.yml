name: Auto PR with Random File

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      # 1. 克隆你自己的仓库（包含 .github）
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          repository: qinjunhaocn/apr
          ref: main
          fetch-depth: 0

      # 2. 配置 Git 用户信息
      - name: Configure Git
        run: |
          git config --global user.name "qinjunhaocn"
          git config --global user.email "avf_j7b6@163.com"

      # 3. 创建并切换到新分支
      - name: Create new branch
        run: |
          BRANCH_NAME="auto-pr-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      # 4. 写入随机文件到 prs/
      - name: Create random file in prs/
        run: |
          FILENAME="prs/random_$(date +%s).txt"
          echo "Auto-generated at $(date)" > "$FILENAME"
          git add "$FILENAME"

      # 5. 提交
      - name: Commit changes
        run: |
          git commit -m "Add random file via GitHub Actions"

      # 6. 推送到你的 fork（保留 .github）
      - name: Push to your fork
        run: |
          git push origin "$BRANCH_NAME"

      # 7. 克隆上游仓库到临时目录
      - name: Clone upstream repo
        run: |
          git clone https://github.com/qinjunhaocn2/apr.git upstream-repo
          cd upstream-repo
          git remote add fork https://x-access-token:${{ secrets.MY_GITHUB_TOKEN }}@github.com/qinjunhaocn/apr.git
          git fetch fork "$BRANCH_NAME"

      # 8. 在上游目录里创建干净分支（不含 .github）
      - name: Create clean branch for upstream
        run: |
          cd upstream-repo
          git checkout -b "$BRANCH_NAME" origin/main
          git checkout fork/"$BRANCH_NAME" -- prs/
          git add prs/
          git commit -m "Add random file via GitHub Actions" --author="github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      # 9. 推送到上游仓库并发起 PR
      - name: Push to upstream and create PR
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          cd upstream-repo
          git remote set-url origin https://x-access-token:${{ secrets.MY_GITHUB_TOKEN }}@github.com/qinjunhaocn2/apr.git
          git push -u origin "$BRANCH_NAME"
          gh pr create \
            --title  "Auto PR: Add random file" \
            --body   "This PR was automatically created by GitHub Actions. It adds a random file to the \`prs/\` directory." \
            --base   main \
            --head   "$BRANCH_NAME" \
            --repo   qinjunhaocn2/apr
